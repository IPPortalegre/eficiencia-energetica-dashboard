<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eficiência Energética | Campus IPP</title>

  <!-- Estilos e bibliotecas -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://kit.fontawesome.com/2f941c78c7.js" crossorigin="anonymous"></script>

  <meta http-equiv="refresh" content="300">

  <style>
    .card h1 {
      font-size: 2rem;
      font-weight: bold;
    }
    .highlight-card {
      border-radius: 12px;
      padding: 10px;
      color: white;
    }
    .green-bg { 
      background-color: #06a04e; 
    }
    .yellow-bg { 
      background-color: #FECB08;
      color: #333; 
      width:220px!important;
      
    }
    .header-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-left:8px;
    }
    .cardnormal {
      width: auto;
      height: auto;
      margin-top: 10px;
      margin-left: -10px;
    }
    .card-body-fonten {
      padding-left: 20px;
      padding-right: 10px;
    }
    .chart-card {
      border-radius: 12px;
      background-color: #f8f9fa;
      margin-left: 10px;
      margin-right: -17px;
    }
    .card {
      box-shadow: 0 4px 8px rgba(48, 48, 48, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      
    }
    .card:hover {
      transform: scale(1.03);
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);

    }
    .square-card {
      width: 200px;
      height: 200px;
    }
    .badge-date {
      font-size: 1.48rem;
      font-weight: bold;
      border-radius: 12px;
    }
    .icon-tree {
      font-size: 36px;
      color: #f8f9fa !important;
    }
    .material-icons {
      color: #343a40;
    }
    .badge-light {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); 
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      background-color:#ffffff;
    }
    .badge-light:hover {
      transform: scale(1.03);
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
    }

    .energy-source {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }

    .cardfonte{
      width: 284px;
      height: 224px;
      margin-left: -1px;
      padding-bottom: 12px;
    }
    #tempicon{
      color: #ff3300;
    }
    #humicon{
      color: #00bcd4;
    }
    .green-card{
      margin-left: 12px!important;
      
    }
    .yellow-card{
      margin-left: 14px!important;
      margin-right:30px!important;
  
      
    }
    .last-card{
      margin-right: 32px!important;
    }
    .graphrow {
      margin-top: 20px;
  
    }
    .cardfonte{
      margin-left:2px;
    }
    .humid{
      color: #00bcd4;
    }
    .tempid{
      color:#ff3300;
    }
    
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap"> 
      <h2 class="header-title">EFICIÊNCIA ENERGÉTICA | CAMPUS IPP</h2>
      <div class="d-flex align-items-center gap-3">
        <span class="badge badge-light p-2 mr-2" data-toggle="tooltip" data-placement="top" title="Temperatura">
          <i class="material-icons md-18 align-middle" id="tempicon">device_thermostat</i>
          <span class="align-middle ml-1 tempid" id="temperatura"></span>
          <span class="align-middle ml-1" id="tempicon">°C</span>
        </span>
        <span class="badge badge-light p-2 mr-2" data-toggle="tooltip" data-placement="top" title="Humidade">
          <i class="material-icons md-18 align-middle" id="humicon">opacity</i>
          <span class="align-middle ml-1 humid" id="humidade"></span>
          <span class="align-middle ml-1" id="humicon">%</span>
        </span>
        <span class="badge badge-light p-2 badge-date" id="currentDate">-</span>
      </div>
    </div>

    <!-- Cards principais -->
    <div class="row text-center mb-3">
      <div class="col-md-2 mx-auto green-card">
        <div class="card cardnormal highlight-card green-bg square-card">
          <div class="card-body">
            <h5>Produção Global Energia</h5>
            <h1 class="value" id="energiasolartotal">-</h1>
            <h5 class="unities">kWh</h5>
          </div>
        </div>
      </div>
      
      <div class="col-md-2 mx-auto green-card">
        <div class="card cardnormal highlight-card green-bg square-card">
          <div class="card-body">
            <h5>CO2 Evitado (acumulado)</h5>
            <h1 class="value" id="co2evitadototal">-</h1>
            <h5 class="unities">ton</h5>
          </div>
        </div>
      </div>
      <div class="col-md-2 mx-auto green-card">
        <div class="card cardnormal highlight-card green-bg square-card">
          <div class="card-body">
            <h5>CO2 Equivalente</h5>
            <h1 id="co2equivalente">-</h1><i class="material-icons icon-tree md-18 align-middle">forest</i>
          </div>
        </div>
      </div>

      <div class="col-md-2 mx-auto yellow-card">
        <div class="card cardnormal highlight-card yellow-bg square-card">
          <div class="card-body">
            <h5>Energia Produzida (instantâneo)</h5>
            <h1 class="value" id="producaoinstantaneo">-</h1>
            <h5 class="unities">kWh</h5>
          </div>
        </div>
      </div>
      
      <div class="col-md-2 mx-auto yellow-card last-card">
        <div class="card cardnormal highlight-card yellow-bg square-card">
          <div class="card-body">
            <h5>Energia Consumida (instantâneo)</h5>
            <h1 class="value" id="consumoinstantaneo">-</h1>
            <h5 class="unities">kWh</h5>
          </div>
        </div>
      </div>
      
    </div>

    <!-- Gráficos -->

    <div class="row graphrow">
      <div class="col-md-3 mb-3">
          <div class="card chart-card cardfonte">
            <div class="card-body card-body-fonten text-center">
              <h5>Fontes de Energia</h5>
              <canvas id="ensource-chart" width="100" height="100"></canvas>
            </div>
          </div>
      </div>

    
      <div class="col-md-4 mb-3">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="text-center">Evolução Temporal - CO2</h5>
            <div class="chart-container">
              <canvas id="chart-co2"></canvas>
            </div>
          </div>
        </div>
      </div>

      
      

      <div class="col-md-5 mb-3">
        <div class="card chart-card">
          <div class="card-body">
            <h5 class="text-center">Evolução Temporal - Energia</h5>
            <div class="chart-container">
              <canvas id="chart-energia"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--gráficos scripts -->
  <script>

   //gráfico fonte de energia
      function createEnergySourceChart(solarValue, redeValue) {
        const ctx = document.getElementById('ensource-chart').getContext('2d');
        
        // Calcular porcentagens se necessário (caso os valores não venham já em porcentagem)
        const total = solarValue + redeValue;
        const solarPercent = Math.round((solarValue / total) * 100);
        const redePercent = Math.round((redeValue / total) * 100);

        energySourceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Fontes de Energia'], 
            datasets: [
              {
                label: 'Solar',
                data: [solarPercent],
                backgroundColor: '#4caf50',
                borderRadius: 14,
                borderSkipped: false,
                barThickness: 40
              },
              {
                label: 'Elétrica',
                data: [redePercent],
                backgroundColor: '#ffc107',
                borderRadius: 14,
                borderSkipped: false,
                barThickness: 40
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: false,
                  pointStyle: 'rectRounded'
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    return `${context.dataset.label}: ${value}%`;
                  }
                }
              }
            },
            scales: {
              x: {
                min: 0,
                max: 100,
                title: {
                  display: false,
                  text: 'Energia (%)'
                },
                ticks: {
                  callback: (val) => `${val}%`
                }
              },
              y: {
                display: false 
              }
            }
          },

        plugins: [{
          
          id: 'materialIconPlugin',
          afterDatasetsDraw(chart) {
            const { ctx, chartArea, scales: { y } } = chart;
            const icons = ['solar_power', 'bolt']; //material icons
            const labels = chart.data.labels;

            ctx.save();
            ctx.font = '20px "Material Icons"';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#15200258'; 

            chart.data.datasets.forEach((dataset, index) => {
              const barHeight = 36;
              const yOffset = chartArea.top + (barHeight + 10) * index + 30; // Ajuste manual
              ctx.fillText(icons[index], chartArea.left + 22, yOffset);
            });

            ctx.restore();
          }
        }]
      });
    }

      function updateEnergySourceChart(solarValue, redeValue) {
        if (!energySourceChart) {
          createEnergySourceChart();
        }

        // Calcular porcentagens
        const total = solarValue + redeValue;
        const solarPercent = Math.round((solarValue / total) * 100);
        const redePercent = Math.round((redeValue / total) * 100);

        // Atualizar os dados do gráfico
        energySourceChart.data.datasets[0].data = [solarPercent];
        energySourceChart.data.datasets[1].data = [redePercent];
        energySourceChart.update();
      }

    let co2Chart, energiaChart, energySourceChart;

  // Initialize CO2 chart with empty data
  function createCO2Chart() {
    const ctx = document.getElementById('chart-co2').getContext('2d');
    
    // Generate last 12 months labels
    const now = new Date();
    const labels = [];
    for (let i = 11; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      labels.push(date.toLocaleString('default', { month: 'short' }));
    }
    
    co2Chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'CO₂ Evitado (ton)',
            data: Array(12).fill(0),
            backgroundColor: '#00bcd4'
          },
          {
            label: 'CO₂ Emitido (ton)',
            data: Array(12).fill(0),
            backgroundColor: '#4caf50'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { stacked: false },
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Update CO2 chart with real data
  function updateCO2Chart(labels, evitadoData, emitidoData) {
    if (!co2Chart) createCO2Chart();
    
    co2Chart.data.labels = labels;
    co2Chart.data.datasets[0].data = evitadoData;
    co2Chart.data.datasets[1].data = emitidoData;
    co2Chart.update();
  }

  // Initialize Energy chart with empty data
  function createEnergiaChart() {
    const ctx = document.getElementById('chart-energia').getContext('2d');
    
    // Generate last 12 months labels
    const now = new Date();
    const labels = [];
    for (let i = 11; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      labels.push(date.toLocaleString('default', { month: 'short' }));
    }
  
  energiaChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Energia Produzida (kWh)',
          data: Array(12).fill(0),
          backgroundColor: '#4caf50'
        },
        {
          label: 'Energia Consumida (kWh)',
          data: Array(12).fill(0),
          backgroundColor: '#ff9800'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { stacked: true },
        y: { stacked: true }
      }
    }
  });
}

// Update Energy chart with real data
function updateEnergiaChart(labels, solarData, redeData) {
  if (!energiaChart) createEnergiaChart();
  
  energiaChart.data.labels = labels;
  energiaChart.data.datasets[0].data = solarData;
  energiaChart.data.datasets[1].data = redeData;
  energiaChart.update();
}

// Initialize on DOM load
    document.addEventListener("DOMContentLoaded", () => {
      createCO2Chart();
      createEnergiaChart();
      refreshData();
      
      // Update current date
      const date = moment();
      document.getElementById("currentDate").textContent = date.format('D/MM/YYYY');
    });

    let date = moment();

    let currentDate = date.format('D/MM/YYYY');
    console.log(currentDate);
    console.log(currentDate); 
    document.getElementById("currentDate").innerHTML = currentDate;

    
    // Arredodnda o valor da temperatura
   

    document.addEventListener("DOMContentLoaded", () => {
      createEnergiaChart();
      createCO2Chart();
      refreshData();
    
    });


  </script>
  <script src="api.js"></script>
</body>
</html>
